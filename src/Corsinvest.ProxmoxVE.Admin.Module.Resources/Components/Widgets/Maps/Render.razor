@*
 * SPDX-FileCopyrightText: Copyright Corsinvest Srl
 * SPDX-License-Identifier: AGPL-3.0-only
*@
@using OpenLayers.Blazor
@inherits AdminComponentBase


@if (Initalized)
{
    <OpenStreetMap @ref="@RefMap"
                   class="rz-w-100 rz-h-100"
                   FullScreenControl="true"
                   OnLayerAdded="OnLayerAdded">
        <Features>
            @foreach (var item in Items)
            {
                <Marker Type="OpenLayers.Blazor.MarkerType.MarkerPin"
                        Coordinate="item.Coordinate"
                        Text="@item.ClusterName"
                        OnClick="@(() => OnMarkerClickAsync(item.ClusterName))"
                        PinColor="item.PinColor" />
            }
        </Features>
    </OpenStreetMap>
}
else
{
    <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}


@code
{
    private async Task OnMarkerClickAsync(string clusterName)
    {
        _ = Task.Run(async () =>
        {
            var resources = await adminService[clusterName].CachedData.GetResourcesAsync(false);

            DataUsages = ResourceUsage.Get(resources, L);
            DataUsages.Add(await ResourceUsage.GetSnapshots(resources, L, adminService[clusterName]));

            var details = resources.Where(a => a.ResourceType is ClusterResourceType.Vm or ClusterResourceType.Node or ClusterResourceType.Storage)
                                   .OrderBy(a => a.ResourceType)
                                   .ThenBy(a => a.Type)
                                   .GroupBy(a => new { a.Type, a.Status })
                                   .Select(a => new
                                   {
                                       Type = a.Key.Type,
                                       Status = a.Key.Status,
                                       // Icon = PveAdminUIHelper.Icons.GetResourceType(a.Key.Type),
                                       // Color = PveAdminUIHelper.GetResourcesColorStatus(a.Key.Status, false),
                                       Count = a.Count()
                                   })
                                   .ToList();

            DialogService.Close();

            await DialogService.OpenAsync(L["Cluster {0}", clusterName], ds =>
                @<RadzenStack Orientation="Orientation.Vertical" Gap="0">
                        <div style="height:100px; overflow:hidden;">
                            <ResourceUsageGauge Data="@DataUsages" class="rz-w-100 rz-h-100" />
                        </div>

                        <RadzenTable AllowAlternatingRows="true">
                            <RadzenTableHeader>
                                <RadzenTableHeaderRow>
                                    <RadzenTableHeaderCell>@L["Type"]</RadzenTableHeaderCell>
                                    <RadzenTableHeaderCell>@L["Status"]</RadzenTableHeaderCell>
                                    <RadzenTableHeaderCell>@L["Count"]</RadzenTableHeaderCell>
                                </RadzenTableHeaderRow>
                            </RadzenTableHeader>

                            <RadzenTableBody>
                                @foreach (var item in details)
                                {
                                    <RadzenTableRow>
                                        <RadzenTableCell>
                                            <IconStatusResource Type="@item.Type" Status="@item.Status" Locked="false" />
                                        </RadzenTableCell>

                                        <RadzenTableCell>@item.Type</RadzenTableCell>
                                        <RadzenTableCell>@item.Count</RadzenTableCell>
                                    </RadzenTableRow>
                                }
                            </RadzenTableBody>
                        </RadzenTable>
                    </RadzenStack>);
                });

            await DialogService.BusyAsync(L["Collect info..."]);
        }
}
